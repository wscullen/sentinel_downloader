name: Bump version
on:
  push:
    branches:
      - master
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: '0'
    - name: Bump version and output tag
      id: get_tag
      uses: anothrNick/github-tag-action@1.26.0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        WITH_V: true
        DEFAULT_BUMP: patch
        INITIAL_VERSION: 1.0.0
        DRY_RUN: true
    - name: Autobump version
      run: |
        echo ${{ steps.get_tag.outputs.new_tag }}
        # from refs/tags/v1.2.3 get 1.2.3
        PLACEHOLDER='__version__ = "0.0.0"'
        VERSION_FILE='setup.py'
        # ensure the placeholder is there. If grep doesn't find the placeholder
        # it exits with exit code 1 and github actions aborts the build. 
        grep "$PLACEHOLDER" "$VERSION_FILE"
        sed -i "s/$PLACEHOLDER/__version__ = \"${{ steps.get_tag.outputs.new_tag }} \"/g" "$VERSION_FILE"
      shell: bash
    - name: Bump version and push tag
      id: push_tag
      uses: anothrNick/github-tag-action@1.26.0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        WITH_V: true
        DEFAULT_BUMP: patch
        INITIAL_VERSION: 1.0.0